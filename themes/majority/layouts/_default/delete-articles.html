{{ define "main" }}
<div class="list-page" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <header class="list-header">
        <h1>{{ .Title }}</h1>
        {{ if .Content }}
        <div class="list-description">
            {{ .Content }}
        </div>
        {{ end }}
    </header>
    
    <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
        <strong>Instructions:</strong>
        <ol style="margin: 10px 0 0 0; padding-left: 20px;">
            <li>Check the boxes next to articles you want to delete</li>
            <li>Click "Generate Deletion Script" button</li>
            <li>Download and run the generated PowerShell script</li>
        </ol>
    </div>
    
    <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
        <button id="select-all" style="padding: 8px 16px; background: #0085C2; color: white; border: none; border-radius: 4px; cursor: pointer;">Select All</button>
        <button id="select-none" style="padding: 8px 16px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Select None</button>
        <span id="selected-count" style="margin-left: 20px; font-weight: bold; color: #dc3545;">0 selected</span>
    </div>
    
    <div class="posts-list" id="articles-list">
        {{ $allPosts := where .Site.RegularPages "Type" "posts" }}
        {{ $cutoffDate := time "2021-01-01" }}
        {{ $oldPosts := where $allPosts ".Date" "<" $cutoffDate }}
        {{ $sortedPosts := sort $oldPosts "Date" "asc" }}
        
        {{ if $sortedPosts }}
            {{ range $sortedPosts }}
            <article class="post-item" style="margin-bottom: 15px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: white;">
                <div style="display: flex; align-items: start; gap: 15px;">
                    <input type="checkbox" 
                           class="article-checkbox" 
                           data-filename="{{ .File.LogicalName }}"
                           data-title="{{ .Title }}"
                           data-date="{{ .Date.Format "2006-01-02" }}"
                           style="margin-top: 5px; width: 20px; height: 20px; cursor: pointer;">
                    <div style="flex: 1;">
                        <h2 style="margin: 0 0 8px 0; font-size: 20px;">
                            <a href="{{ .Permalink }}" style="text-decoration: none; color: inherit;">{{ .Title }}</a>
                        </h2>
                        <div style="color: #666; font-size: 14px; margin-bottom: 8px;">
                            <strong>Date:</strong> {{ .Date.Format "January 2, 2006" }} ({{ .Date.Format "2006-01-02" }})
                        </div>
                        <div style="color: #999; font-size: 12px;">
                            <strong>File:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">{{ .File.LogicalName }}</code>
                        </div>
                    </div>
                </div>
            </article>
            {{ end }}
        {{ else }}
            <p style="padding: 20px; text-align: center; color: #666;">No articles found before 2021.</p>
        {{ end }}
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 4px; text-align: center;">
        <button id="generate-script" 
                style="padding: 12px 24px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;"
                disabled>
            Generate Deletion Script
        </button>
        <div id="script-output" style="margin-top: 20px; display: none;">
            <textarea id="script-content" 
                      readonly 
                      style="width: 100%; min-height: 200px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; border: 1px solid #ddd; border-radius: 4px; background: white;"></textarea>
            <button id="download-script" 
                    style="margin-top: 10px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Download Script
            </button>
        </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: #f8d7da; border: 1px solid #dc3545; border-radius: 4px;">
        <strong>⚠️ Warning:</strong> This will permanently delete the selected articles. Make sure you have backups if needed.
    </div>
</div>

<script>
(function() {
    const checkboxes = document.querySelectorAll('.article-checkbox');
    const selectAllBtn = document.getElementById('select-all');
    const selectNoneBtn = document.getElementById('select-none');
    const selectedCount = document.getElementById('selected-count');
    const generateBtn = document.getElementById('generate-script');
    const scriptOutput = document.getElementById('script-output');
    const scriptContent = document.getElementById('script-content');
    const downloadBtn = document.getElementById('download-script');
    
    function updateCount() {
        const checked = document.querySelectorAll('.article-checkbox:checked').length;
        selectedCount.textContent = checked + ' selected';
        generateBtn.disabled = checked === 0;
    }
    
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateCount);
    });
    
    selectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = true);
        updateCount();
    });
    
    selectNoneBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateCount();
    });
    
    generateBtn.addEventListener('click', function() {
        const selected = Array.from(document.querySelectorAll('.article-checkbox:checked'));
        
        if (selected.length === 0) {
            alert('Please select at least one article.');
            return;
        }
        
        let script = '# Script to mark selected articles for deletion\n';
        script += '# Generated: ' + new Date().toLocaleString() + '\n';
        script += '# Total articles: ' + selected.length + '\n\n';
        script += '$contentPath = "content\\posts"\n\n';
        
        selected.forEach((cb, index) => {
            const filename = cb.getAttribute('data-filename');
            const title = cb.getAttribute('data-title');
            const date = cb.getAttribute('data-date');
            
            script += `# ${index + 1}. ${title} (${date})\n`;
            script += `$filePath = Join-Path $contentPath "${filename}"\n`;
            script += `if (Test-Path $filePath) {\n`;
            script += `    $content = Get-Content $filePath -Raw -Encoding UTF8\n`;
            script += `    if ($content -notmatch 'deleted\\s*=\\s*true') {\n`;
            script += `        if ($content -match '(?s)(\\+\\+\\+.*?)(draft\\s*=\\s*[^\\r\\n]+)') {\n`;
            script += `            $newContent = $content -replace '(?s)(\\+\\+\\+.*?)(draft\\s*=\\s*[^\\r\\n]+)', "`$1`$2`r`ndeleted = true"\n`;
            script += `        } elseif ($content -match '(?s)(\\+\\+\\+.*?)(\\+\\+\\+)') {\n`;
            script += `            $newContent = $content -replace '(?s)(\\+\\+\\+.*?)(\\+\\+\\+)', "`$1deleted = true`r`n`$2"\n`;
            script += `        } else {\n`;
            script += `            Write-Warning "Could not parse front matter in: $filePath"\n`;
            script += `            continue\n`;
            script += `        }\n`;
            script += `        Set-Content -Path $filePath -Value $newContent -Encoding UTF8 -NoNewline\n`;
            script += `        Write-Host "Marked for deletion: ${filename}" -ForegroundColor Red\n`;
            script += `    } else {\n`;
            script += `        Write-Host "Already marked: ${filename}" -ForegroundColor Yellow\n`;
            script += `    }\n`;
            script += `} else {\n`;
            script += `    Write-Warning "File not found: $filePath"\n`;
            script += `}\n\n`;
        });
        
        script += 'Write-Host "`nMarked ' + selected.length + ' articles for deletion." -ForegroundColor Green\n';
        script += 'Write-Host "Run .\\delete-marked-articles.ps1 to delete them permanently." -ForegroundColor Yellow\n';
        
        scriptContent.value = script;
        scriptOutput.style.display = 'block';
        scriptOutput.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    
    downloadBtn.addEventListener('click', function() {
        const blob = new Blob([scriptContent.value], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'mark-articles-for-deletion.ps1';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });
    
    updateCount();
})();
</script>

<style>
.post-item:hover {
    background: #f8f9fa !important;
}

.article-checkbox:checked + div h2 {
    text-decoration: line-through;
    opacity: 0.7;
}
</style>
{{ end }}

